# Generated by Django 5.2.5 on 2025-09-02 21:23

from django.db import migrations
from django.utils.translation import gettext_lazy as _
import notes.deprecated.deprecated_enums


def copy_service_enum_to_service(apps, schema_editor):
    ServiceRequest = apps.get_model("notes", "ServiceRequest")
    OrganizationService = apps.get_model("notes", "OrganizationService")
    db_alias = schema_editor.connection.alias

    enum_to_pk_map = {}

    for enum in [
        e
        for e in notes.deprecated.deprecated_enums.ServiceEnum
        if e != notes.deprecated.deprecated_enums.ServiceEnum.OTHER
    ]:
        enum_to_pk_map[enum] = OrganizationService.objects.using(db_alias).get(label=enum.label).pk

    for enum in enum_to_pk_map:
        ServiceRequest.objects.using(db_alias).filter(service_enum=enum).update(service_id=enum_to_pk_map[enum])


def create_services_from_service_other(apps, schema_editor):
    ServiceRequest = apps.get_model("notes", "ServiceRequest")
    OrganizationService = apps.get_model("notes", "OrganizationService")
    db_alias = schema_editor.connection.alias

    other_services = ServiceRequest.objects.using(db_alias).filter(
        service_enum=notes.deprecated.deprecated_enums.ServiceEnum.OTHER
    )

    for svc_req in other_services:
        svc, _ = OrganizationService.objects.using(db_alias).get_or_create(
            category=None,
            label=svc_req.service_other,
            organization=svc_req.created_by.groups.first().permissiongroup.organization,
        )
        svc_req.service = svc
        svc_req.save()


def clear_service(apps, schema_editor):
    ServiceRequest = apps.get_model("notes", "ServiceRequest")
    db_alias = schema_editor.connection.alias

    ServiceRequest.objects.using(db_alias).all().update(service=None)


class Migration(migrations.Migration):

    dependencies = [
        ("notes", "0026_rename_service_to_label"),
    ]

    operations = [
        migrations.RunPython(copy_service_enum_to_service, clear_service),
        migrations.RunPython(create_services_from_service_other, clear_service),
    ]
