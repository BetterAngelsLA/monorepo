"""
Django settings for betterangels_backend project.

Generated by 'django-admin startproject' using Django 4.2.4.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/4.2/ref/settings/
"""

import os
from pathlib import Path
from typing import List

import django_stubs_ext
import environ
import structlog

django_stubs_ext.monkeypatch()


env = environ.Env(
    ACCOUNT_DEFAULT_HTTP_PROTOCOL=(str, "http"),
    ALLOWED_HOSTS=(list, []),
    AWS_REGION=(str, "us-west-2"),
    AWS_SES_REGION_NAME=(str, ""),
    AWS_SES_REGION_ENDPOINT=(str, "email.us-west-2.amazonaws.com"),
    AWS_S3_STORAGE_BUCKET_NAME=(str, ""),
    AWS_S3_CUSTOM_DOMAIN=(str, ""),
    AWS_S3_MEDIA_STORAGE_ENABLED=(bool, False),
    AWS_CLOUDFRONT_KEY=(str, ""),
    AWS_CLOUDFRONT_KEY_ID=(str, ""),
    AWS_CLOUDFRONT_MEDIA_LOCATION=(str, "media"),
    CELERY_BROKER_URL=(str, ""),
    CELERY_REDBEAT_REDIS_URL=(str, ""),
    CONN_MAX_AGE=(int, 300),
    CSRF_TRUSTED_ORIGINS=(list, []),
    CSRF_COOKIE_DOMAIN=(str, ""),
    CSRF_COOKIE_SECURE=(bool, True),
    CORS_ALLOW_ALL_ORIGINS=(bool, False),
    CORS_ALLOWED_ORIGINS=(list, []),
    CORS_ALLOWED_ORIGIN_REGEXES=(list, []),
    DEBUG=(bool, False),
    DEFAULT_FROM_EMAIL=(str, ""),
    DJANGO_CACHE_URL=(str, ""),
    DJANGO_CACHE_BLOCKING_TIMEOUT=(float, 1.0),
    DJANGO_CACHE_MAX_CONNECTIONS=(int, 100),
    GOOGLE_MAPS_API_KEY=(str, ""),
    HMIS_API_KEY=(str, ""),
    HMIS_GRAPHQL_URL=(str, ""),
    HMIS_SESSION_KEY=(str, ""),
    HMIS_TOKEN_KEY=(str, ""),
    IS_LOCAL_DEV=(bool, False),
    LANGUAGE_COOKIE_SECURE=(bool, True),
    MEDIA_URL=(str, "/media/"),
    POST_OFFICE_EMAIL_BACKEND=(str, ""),
    POSTGRES_NAME=(str, "postgres"),
    POSTGRES_USER=(str, "postgres"),
    POSTGRES_PASSWORD=(str, "postgres"),
    POSTGRES_HOST=(str, "db"),
    SECRET_KEY=(str, "secret_key"),
    SESSION_COOKIE_AGE=(int, 172800),  # Defaults to two days in seconds
    SESSION_COOKIE_SECURE=(bool, True),
    SESSION_COOKIE_HTTPONLY=(bool, True),
    SECURE_HSTS_INCLUDE_SUBDOMAINS=(bool, False),
    SECURE_HSTS_PRELOAD=(bool, False),
    SECURE_HSTS_SECONDS=(int, 0),
    ACCOUNT_LOGIN_BY_CODE_ENABLED=(bool, False),
    USE_IAM_AUTH=(bool, False),
)

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

IS_LOCAL_DEV = env("IS_LOCAL_DEV")
if IS_LOCAL_DEV:
    environ.Env.read_env(env_file=os.path.join(BASE_DIR, ".env"))
    environ.Env.read_env(env_file=os.path.join(BASE_DIR, ".env.local"), overwrite=True)


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/
SECRET_KEY = env("SECRET_KEY")
DEBUG = env("DEBUG")

# Application definition
INSTALLED_APPS = [
    "admin_async_upload",
    "admin_interface",
    "adminsortable2",
    "betterangels_backend.apps.CustomAdminConfig",
    "colorfield",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.gis",
    "django.contrib.sessions",
    "django.contrib.messages",
    "whitenoise.runserver_nostatic",
    "django.contrib.staticfiles",
    "django.contrib.sites",
    "django_extensions",
    # 3rd Party
    "allauth",
    "allauth.account",
    "allauth.headless",
    "corsheaders",
    "django_ckeditor_5",
    "django_structlog",
    "guardian",
    "places",
    "post_office",
    "rest_framework",
    "organizations",
    "phonenumber_field",
    "pghistory",
    "pghistory.admin",
    "pgtrigger",
    "django_select2",
    "import_export",
    "rangefilter",
    "strawberry_django",
    "waffle",
    # Our Apps
    "accounts",
    "clients",
    "common",
    "hmis",
    "legal",
    "notes",
    "proxy",
    "shelters",
    "tasks",
]

MIDDLEWARE = [
    "django_structlog.middlewares.RequestMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    "allauth.account.middleware.AccountMiddleware",
    "pghistory.middleware.HistoryMiddleware",
    # Our Middleware
    "common.middleware.TimezoneMiddleware",
]

ACCOUNT_ADAPTER = "accounts.adapters.AccountAdapter"
ACCOUNT_EMAIL_UNKNOWN_ACCOUNTS = False
ACCOUNT_LOGIN_BY_CODE_ENABLED = env("ACCOUNT_LOGIN_BY_CODE_ENABLED")

ROOT_URLCONF = "betterangels_backend.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [
            os.path.normpath(os.path.join(BASE_DIR, "templates")),
        ],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
                "django.template.context_processors.request",
            ],
        },
    }
]

AUTHENTICATION_BACKENDS = [
    "django.contrib.auth.backends.ModelBackend",
    "guardian.backends.ObjectPermissionBackend",
    # `allauth` specific authentication methods, such as login by email
    "allauth.account.auth_backends.AuthenticationBackend",
]

REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": ("rest_framework.authentication.SessionAuthentication",),
    # Tokens by default are not unique accross devices.
    # We want to use session auth by default for now.
    "TOKEN_CREATOR": None,
    "TOKEN_MODEL": None,
}

STRAWBERRY_DJANGO = {
    "MUTATIONS_DEFAULT_HANDLE_ERRORS": True,
}

WSGI_APPLICATION = "betterangels_backend.wsgi.application"

# Celery
CELERY_BROKER_URL = env("CELERY_BROKER_URL")
CELERY_REDBEAT_REDIS_URL = env("CELERY_REDBEAT_REDIS_URL")

# Caches
CACHES = {
    "default": {
        "BACKEND": "django.core.cache.backends.redis.RedisCache",
        "LOCATION": env("DJANGO_CACHE_URL"),
        "OPTIONS": {
            "pool_class": "redis.BlockingConnectionPool",
            "max_connections": env("DJANGO_CACHE_MAX_CONNECTIONS"),
            "timeout": env("DJANGO_CACHE_BLOCKING_TIMEOUT"),
        },
    }
}


# Database
# https://docs.djangoproject.com/en/4.2/ref/settings/#databases
DATABASES = {
    "default": {
        "ENGINE": "common.backends.iam_dbauth.postgis",
        "NAME": env("POSTGRES_NAME"),
        "USER": env("POSTGRES_USER"),
        "PASSWORD": env("POSTGRES_PASSWORD"),
        "HOST": env("POSTGRES_HOST"),
        "PORT": "5432",
        "CONN_MAX_AGE": env("CONN_MAX_AGE"),
        "IAM_SETTINGS": {
            "ENABLED": env("USE_IAM_AUTH"),
            "REGION_NAME": env("AWS_REGION"),
        },
    },
}

DJANGO_EXTENSIONS_RESET_DB_POSTGRESQL_ENGINES = ["common.backends.iam_dbauth.postgis"]

AUTH_USER_MODEL = "accounts.User"

# Password validation
# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator",  # noqa: B950
    },
    {
        "NAME": "django.contrib.auth.password_validation.MinimumLengthValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.CommonPasswordValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.NumericPasswordValidator",
    },
]


# Internationalization
# https://docs.djangoproject.com/en/4.2/topics/i18n/

LANGUAGE_CODE = "en-us"

TIME_ZONE = "UTC"

USE_I18N = True

USE_TZ = True

# Storage Settings
if env("AWS_S3_MEDIA_STORAGE_ENABLED"):
    STORAGES = {
        "default": {
            "BACKEND": "storages.backends.s3.S3Storage",
            "OPTIONS": {
                "bucket_name": env("AWS_S3_STORAGE_BUCKET_NAME"),
                "cloudfront_key": env("AWS_CLOUDFRONT_KEY").encode("ascii"),
                "cloudfront_key_id": env("AWS_CLOUDFRONT_KEY_ID"),
                "custom_domain": env("AWS_S3_CUSTOM_DOMAIN"),
                "location": env("AWS_CLOUDFRONT_MEDIA_LOCATION"),
                "signature_version": "s3v4",
            },
        },
        "staticfiles": {
            "BACKEND": "django.contrib.staticfiles.storage.StaticFilesStorage",
        },
    }


ADMIN_RESUMABLE_CHUNKSIZE = 10 * 1024 * 1024
ADMIN_RESUMABLE_SHOW_THUMB = True
ADMIN_SIMULTANEOUS_UPLOADS = 5

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.2/howto/static-files/

STATIC_URL = "static/"
STATIC_ROOT = BASE_DIR / "staticfiles"

# Media settings
MEDIA_URL = env("MEDIA_URL")
MEDIA_ROOT = os.path.join(BASE_DIR, "media")

# Default primary key field type
# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

LOGIN_REDIRECT_URL = "home"
LOGOUT_REDIRECT_URL = "home"
LOGIN_URL = "/accounts/login/"

# django-organizations settings
ORGS_SLUGFIELD = "django_extensions.db.fields.AutoSlugField"


# ALL AUTH SETTINGS
ACCOUNT_EMAIL_CONFIRMATION_EXPIRE_DAYS = 7
"""
ACCOUNT_EMAIL_REQUIRED (default: False)
The user is required to hand over an email address when signing up.
"""
# ACCOUNT_EMAIL_REQUIRED = True
"""
ACCOUNT_EMAIL_VERIFICATION (default: "optional")
Determines the email verification method during signup
- choose one of "mandatory", "optional", or "none".

Setting this to "mandatory" requires ACCOUNT_EMAIL_REQUIRED to be True.

When set to "mandatory" the user is blocked
from logging in until the email address is
verified. Choose "optional"
or "none" to allow logins with an unverified
email address. In case of "optional", the email verification mail is
still sent, whereas in case of “none” no email verification mails are sent.
"""
# ACCOUNT_EMAIL_VERIFICATION = "mandatory"

# EMAIL Backend
AWS_SES_REGION_NAME = env("AWS_SES_REGION_NAME") or env("AWS_REGION")
AWS_SES_REGION_ENDPOINT = env("AWS_SES_REGION_ENDPOINT")
USE_SES_V2 = True

EMAIL_BACKEND = "common.backends.email.CustomPostOfficeEmailBackend"
DEFAULT_FROM_EMAIL = env("DEFAULT_FROM_EMAIL")
POST_OFFICE = {
    "BACKENDS": {
        "default": env("POST_OFFICE_EMAIL_BACKEND"),
    },
    "CELERY_ENABLED": True,
}
EMAIL_FILE_PATH = "./tmp/app-emails"  # change this to your preferred location
INVITATION_BACKEND = "accounts.backends.CustomInvitations"

# Django Guardian
# https://github.com/django-guardian/django-guardian/blob/77de2033951c2e6b8fba2ac6258defdd23902bbf/docs/configuration.rst#guardian_user_obj_perms_model
# https://github.com/django-guardian/django-guardian/blob/77de2033951c2e6b8fba2ac6258defdd23902bbf/docs/configuration.rst#guardian_group_obj_perms_model
ANONYMOUS_USER_NAME = "anonymoususer"
GUARDIAN_USER_OBJ_PERMS_MODEL = "accounts.BigUserObjectPermission"
GUARDIAN_GROUP_OBJ_PERMS_MODEL = "accounts.BigGroupObjectPermission"

# Google Maps
GOOGLE_MAPS_API_KEY = env("GOOGLE_MAPS_API_KEY")
PLACES_MAPS_API_KEY = GOOGLE_MAPS_API_KEY
PLACES_MAP_WIDGET_HEIGHT = 480
PLACES_MAP_OPTIONS = '{"center": { "lat": 34.0549, "lng": -118.2426 }, "zoom": 10}'
PLACES_MARKER_OPTIONS = '{"draggable": true}'

# HMIS
HMIS_API_KEY = env("HMIS_API_KEY")
HMIS_GRAPHQL_URL = env("HMIS_GRAPHQL_URL")
HMIS_SESSION_KEY = env("HMIS_SESSION_KEY")
HMIS_TOKEN_KEY = env("HMIS_TOKEN_KEY")

# Logging Configuration
# https://django-structlog.readthedocs.io/en/latest/getting_started.html
# https://betterstack.com/community/guides/logging/structlog/
LOGGING = {
    "version": 1,
    "disable_existing_loggers": True,
    "formatters": {
        "json_formatter": {
            "()": structlog.stdlib.ProcessorFormatter,
            "processor": structlog.processors.JSONRenderer(),
        },
    },
    "handlers": {
        "console": {
            "class": "logging.StreamHandler",
            "formatter": "json_formatter",
        },
    },
    "loggers": {
        "django_structlog": {
            "handlers": ["console"],
            "level": "INFO",
        },
    },
}

structlog.configure(
    processors=[
        structlog.contextvars.merge_contextvars,
        structlog.stdlib.filter_by_level,
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.stdlib.add_log_level,
        structlog.stdlib.PositionalArgumentsFormatter(),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.UnicodeDecoder(),
        structlog.stdlib.ProcessorFormatter.wrap_for_formatter,
    ],
    logger_factory=structlog.stdlib.LoggerFactory(),
    cache_logger_on_first_use=True,
)

# Markdown Settings
CKEDITOR_5_CONFIGS = {
    "default": {
        "toolbar": [
            "heading",
            "|",
            "bold",
            "italic",
            "link",
            "bulletedList",
            "numberedList",
            "blockQuote",
        ],
    },
}

# Test Runner
TEST_RUNNER = "betterangels_backend.runner.PytestTestRunner"

SITE_ID = 1

ACCOUNT_DEFAULT_HTTP_PROTOCOL = env("ACCOUNT_DEFAULT_HTTP_PROTOCOL")
ALLOWED_HOSTS: List[str] = env("ALLOWED_HOSTS")
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_ALL_ORIGINS = env("CORS_ALLOW_ALL_ORIGINS")
CORS_ALLOWED_ORIGINS = env("CORS_ALLOWED_ORIGINS")
CORS_ALLOWED_ORIGIN_REGEXES = env("CORS_ALLOWED_ORIGIN_REGEXES")
CSRF_COOKIE_DOMAIN = env("CSRF_COOKIE_DOMAIN")
CSRF_COOKIE_SECURE = env("CSRF_COOKIE_SECURE")
CSRF_TRUSTED_ORIGINS = env("CSRF_TRUSTED_ORIGINS")
LANGUAGE_COOKIE_SECURE = env("LANGUAGE_COOKIE_SECURE")
SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")
SESSION_COOKIE_HTTPONLY = env("SESSION_COOKIE_HTTPONLY")
SESSION_COOKIE_AGE = env("SESSION_COOKIE_AGE")
SESSION_COOKIE_SECURE = env("SESSION_COOKIE_SECURE")
SESSION_ENGINE = "django.contrib.sessions.backends.cache"
SESSION_SAVE_EVERY_REQUEST = True
SECURE_HSTS_INCLUDE_SUBDOMAINS = env("SECURE_HSTS_INCLUDE_SUBDOMAINS")
SECURE_HSTS_PRELOAD = env("SECURE_HSTS_PRELOAD")
SECURE_HSTS_SECONDS = env("SECURE_HSTS_SECONDS")
X_FRAME_OPTIONS = "SAMEORIGIN"

RUNSCRIPT_LOG_TO_STDOUT = True

# Phonenumber Field
PHONENUMBER_DEFAULT_REGION = "US"
# NOTE: Changing or removing these settings can result in loss of phone extension data
# https://django-phonenumber-field.readthedocs.io/en/latest/reference.html#phone-number-format-choices
PHONENUMBER_DB_FORMAT = "INTERNATIONAL"
PHONENUMBER_DEFAULT_FORMAT = "INTERNATIONAL"
