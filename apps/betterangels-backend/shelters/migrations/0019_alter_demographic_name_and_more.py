# Generated by Django 5.2 on 2025-04-25 19:52

import django_choices_field.fields
import shelters.enums
from django.db import migrations


def update_enum_values_forward(apps, schema_editor):
    # Use raw SQL to update the enum values directly in the database
    schema_editor.execute("""
        INSERT INTO shelters_demographic (name)
        SELECT name FROM shelters_specialsituationrestriction WHERE name = 'lgbtq_plus';

        INSERT INTO shelters_shelter_demographics (shelter_id, demographic_id)
        SELECT
            mt.shelter_id,
            co.id
        FROM shelters_shelter_special_situation_restrictions mt
        JOIN shelters_specialsituationrestriction ct ON mt.specialsituationrestriction_id = ct.id
        JOIN shelters_demographic co ON co.name = ct.name
        WHERE ct.name = 'lgbtq_plus';

        DELETE FROM shelters_shelter_special_situation_restrictions AS mt
        USING shelters_specialsituationrestriction AS ct
        WHERE mt.specialsituationrestriction_id = ct.id
        AND ct.name = 'lgbtq_plus';

        DELETE FROM shelters_specialsituationrestriction WHERE name = 'lgbtq_plus';
    """)


class Migration(migrations.Migration):

    dependencies = [
        ("shelters", "0018_modify_shelter_group_permissions"),
    ]

    operations = [
        migrations.AlterField(
            model_name="demographic",
            name="name",
            field=django_choices_field.fields.TextChoicesField(
                blank=True,
                choices=[
                    ("all", "All"),
                    ("single_men", "Single Men"),
                    ("single_women", "Single Women"),
                    ("tay_teen", "TAY/Teen"),
                    ("seniors", "Seniors"),
                    ("families", "Families"),
                    ("single_moms", "Single Moms"),
                    ("single_dads", "Single Dads"),
                    ("lgbtq_plus", "LGBTQ+"),
                    ("other", "Other"),
                ],
                choices_enum=shelters.enums.DemographicChoices,
                max_length=12,
                null=True,
                unique=True,
            ),
        ),
        migrations.AlterField(
            model_name="specialsituationrestriction",
            name="name",
            field=django_choices_field.fields.TextChoicesField(
                blank=True,
                choices=[
                    ("none", "None"),
                    ("domestic_violence", "Domestic Violence (DV/IPV)"),
                    ("hiv_aids", "HIV/AIDS"),
                    ("human_trafficking", "Human Trafficking"),
                    ("justice_systems", "Persons Exiting Justice Systems"),
                    ("veterans", "Veterans"),
                ],
                choices_enum=shelters.enums.SpecialSituationRestrictionChoices,
                max_length=17,
                null=True,
                unique=True,
            ),
        ),
        migrations.RunPython(update_enum_values_forward),
    ]
