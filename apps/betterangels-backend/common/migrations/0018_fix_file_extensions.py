# Generated by Django 5.2 on 2025-05-27 19:13

from django.db import migrations
from django.db.models import Q


def append_missing_extension(apps, schema_editor):
    Attachment = apps.get_model("common", "Attachment")
    table = Attachment._meta.db_table

    # this isn't exhaustive but it captures everything currently in prod
    mime_ext_map = {
        "application/pdf": [".pdf"],
        "image/heic": [".heic"],
        "image/jpeg": [".jpg", ".jpeg"],
        "application/zip": [".zip"],
    }

    with schema_editor.connection.cursor() as cursor:
        for mime_type, valid_exts in mime_ext_map.items():
            ext = valid_exts[0]

            not_like_sql = " AND ".join("RIGHT(original_filename, CHAR_LENGTH(%s)) NOT ILIKE %s" for _ in valid_exts)
            params = [ext, mime_type] + [val for e in valid_exts for val in (e, e)]

            cursor.execute(
                f"""
                UPDATE "{table}"
                   SET original_filename = original_filename || %s
                 WHERE mime_type = %s
                   AND original_filename IS NOT NULL
                   AND original_filename <> ''
                   AND {not_like_sql};
            """,
                params,
            )


class Migration(migrations.Migration):

    dependencies = [
        ("common", "0017_remove_attachment_associated_with"),
    ]

    operations = [migrations.RunPython(append_missing_extension, migrations.RunPython.noop)]
