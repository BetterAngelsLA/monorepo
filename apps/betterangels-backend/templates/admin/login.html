{% extends "admin/login.html" %}
{% block extrahead %}
  {{ block.super }}
  <style>
    /* Container styling */
    #custom-login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: 0 auto;
      max-width: 450px;
    }
    .login-section {
      width: 100%;
      padding: 20px;
      border: 1px solid var(--hairline-color);
      border-radius: 4px;
      background-color: var(--body-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .login-section h2 {
      margin: 0 0 15px;
      font-size: 1.2em;
      text-align: center;
      color: var(--body-quiet-color);
    }
    .login-divider { display: flex; align-items: center; width: 100%; }
    .login-divider hr { flex-grow: 1; border: none; border-top: 1px solid var(--hairline-color); margin: 0; }
    .login-divider span { margin: 0 10px; font-weight: bold; color: var(--body-quiet-color); white-space: nowrap; }
    .form-row { margin-bottom: 15px; }
    .submit-row { text-align: center; }
    .login-section input[type="email"], .login-section input[type="text"] {
      width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--border-color);
    }
    .errornote { color: var(--error-fg); background: var(--error-bg); border: 1px solid var(--error-border); padding: 10px; margin-bottom: 15px; }
    .help-text { color: var(--body-quiet-color); font-size: 0.9em; margin-top: 10px; }
  </style>
{% endblock extrahead %}
{% block content %}
  <div id="custom-login-container">
    {% if is_local_dev %}
      <div class="login-section">
        <h2>Password Login</h2>
        {{ block.super }}
      </div>
      <div class="login-divider">
        <hr>
        <span>OR</span>
        <hr>
      </div>
    {% endif %}
    <div class="login-section">
      <h2>OTP Login</h2>
      <form id="otp-form" novalidate>
        {% csrf_token %}
        <div class="form-row" id="email-step">
          <label for="id_otp_email" class="required">Email:</label>
          <input type="email" name="email" id="id_otp_email" required />
        </div>
        <div class="form-row" id="code-step" style="display: none;">
          <label for="id_otp_code" class="required">Code:</label>
          <input type="text" name="code" id="id_otp_code" disabled />
        </div>
        <div class="submit-row">
          <input type="submit"
                 id="otp-submit-btn"
                 class="admin-button"
                 value="Send Code" />
        </div>
      </form>
      <p id="otp-status" class="help-text" style="display: none;"></p>
      <p id="otp-error" class="errornote" style="display: none;"></p>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('otp-form');
      const emailStep = document.getElementById('email-step');
      const codeStep = document.getElementById('code-step');
      const emailInput = document.getElementById('id_otp_email');
      const codeInput = document.getElementById('id_otp_code');
      const submitBtn = document.getElementById('otp-submit-btn');
      const statusMsg = document.getElementById('otp-status');
      const errorNote = document.getElementById('otp-error');
      let pending = false;

      const csrfToken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';

      const post = async (url, payload) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        let json = {};
        try { json = await res.json(); } catch {};
        return { res, json };
      };

      form.addEventListener('submit', async e => {
        e.preventDefault();
        submitBtn.disabled = true;
        errorNote.style.display = 'none';
        statusMsg.style.display = 'none';

        try {
          if (!pending) {
            // Clear any existing session
            await fetch('{% url "headless:browser:account:current_session" %}', { method: 'DELETE', credentials: 'same-origin', headers: { 'X-CSRFToken': csrfToken } });

            // Request login code
            const { res, json } = await post('{% url "headless:browser:account:request_login_code" %}', { email: emailInput.value });
            const needsCode = res.status === 401 && json.data?.flows?.some(f => f.id === 'login_by_code' && f.is_pending);
            if (!needsCode) throw new Error(json.detail || 'Error requesting code');

            pending = true;
            emailStep.style.display = 'none';
            codeStep.style.display = 'block';
            codeInput.disabled = false;
            codeInput.focus();
            submitBtn.value = 'Verify Code';

            statusMsg.textContent = 'Check your email for the login code.';
            statusMsg.style.display = 'block';
          } else {
            // Verify login code
            const { res, json } = await post('{% url "headless:browser:account:confirm_login_code" %}', { email: emailInput.value, code: codeInput.value });
            if (!res.ok) throw new Error(json.detail || 'Verification failed');
            window.location.href = '/admin/';
          }
        } catch (err) {
          errorNote.textContent = err.message;
          errorNote.style.display = 'block';
          // Reset for new attempt
          pending = false;
          emailStep.style.display = 'block';
          codeStep.style.display = 'none';
          submitBtn.value = 'Send Code';
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
  </script>
{% endblock content %}
