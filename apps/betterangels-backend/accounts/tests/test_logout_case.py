from accounts.models import User
from django.core.cache import cache
from django.test import TestCase, ignore_warnings
from model_bakery import baker
from test_utils.mixins import GraphQLTestCaseMixin


@ignore_warnings(category=UserWarning)
class CurrentUserGraphQLTests(GraphQLTestCaseMixin, TestCase):
    def test_anonymous_user_logout(self) -> None:
        query = """
        mutation {
            logout
        }
        """
        response = self.execute_graphql_query(query)
        self.assertIsNone(response.get("errors"))
        self.assertEqual(response["data"]["logout"], False)

    def test_logged_in_user_logout(self) -> None:
        user = baker.make(User, email="test@example.com", username="testuser")
        self.graphql_client.force_login(user)
        session_cache_key = (
            f"django.contrib.sessions.cache{self.graphql_client.session.session_key}"
        )

        query = """
        mutation {
            logout
        }
        """
        response = self.execute_graphql_query(query)
        self.assertIsNone(response.get("errors"))
        self.assertEqual(response["data"]["logout"], True)
        self.assertIsNone(cache.get(session_cache_key))
